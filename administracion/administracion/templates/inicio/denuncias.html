{% extends 'base.html' %}
{% block title %}.:Denuncias:.{% endblock %}
{% block contenidos %}
{% if not user.is_authenticated %}
	<script type="text/javascript">
	$(document).ready(function(){
		alert('Inicie sesion')
	})
	</script>
	<style type="text/css">
	html{
		display: none;
	}
	</style>
{% else %}
<link rel="stylesheet" type="text/css" href="/static/css/formularios.css">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-2" />
<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript">
$(document).ready(function() {

});
function ventanaSecundaria(URL){
                window.open(URL,"Editar","width=500,height=300,scrollbars=NO top=150 left=550");
    }
</script>
</head>
<audio id="player" src="/static/tonos/sonidoUno.mp3">
		</audio>
<div id='comentario'>
	{% for comment in comments %}
		<li><a href="javascript:ventanaSecundaria('/DetalleDenuncias/{{comment.id}}/')">{{ comment.user}}  Denuncio:  {{comment.comment}}     Cod:{{comment.idNegocio}}</a></li>
	{% endfor %} 
<li class='cuenta'>Numero de Notificaciones registradas hasta la fecha: {{cont}}      <a href="/TodaslasDenuncias/">Ver Todos</a></li>
</div>
<div id="map_canvas"></div>
<!-- <li>Negocio a denunciar::{{nego.propietario}}</li><br> -->
<div class="card">
<form method='POST' id='for'>{% csrf_token %}
	<input type='hidden' name='name' id='name' value='Admin' required>
	<textarea id="id_comment" name="comment"> </textarea> 
	<input type='text' name='idNegocio' id='id_idNegocio' required
	placeholder='Ingrese al Codigo del negocio'><br>
	<!-- <input type='text' name='paran' value=>
	onclick="this.disabled=true; this.value='Enviando...'; this.form.submit()" -->
	<button id ="boton" name="enviar">Notificar</button>
</form>
</div>
<script src="/static/js/jquery.min3.js"></script>
<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script>
	var socket = io.connect("http://localhost:3000");
	$('#map_canvas').text("Cargando Google Maps...");
 $('#boton').on('click',	Denuncia);
	function Denuncia(e){
		e.preventDefault();
		//son los datos que recuperamos del formulario
		var datos = {
			user: $('#name').val(),
			comment:$('#id_comment').val(),
			idNegocio:$('#id_idNegocio').val()
		}
		//var info=datos.comment.length;
		if(datos.user.length==0 || datos.comment.length==1 || datos.idNegocio.length == 0){
			alert('Por favor Escriba una Denuncia....');
		}
		else{
			console.log(datos);
			socket.emit('nuevo comentario', datos);
		}
	}
	socket.on('devolviendo comentario', function(data){
		var data =JSON.parse(data);
		$("#comentario").prepend("<p>"+data.user+ "   Denuncio     " +data.comment+"     Cod    "+data.idNegocio+"</p>");
		$("#id_comment").val("");

    	var playing = true;
        $(this).toggleClass("down");
        if (playing == true) {
            document.getElementById('player').play();
            playing = true;
            //$(this).text("Parar Sonido");
        }

		$('.cuenta').html('Numero de Notificaciones registradas hasta la fecha:'+data.cont+"<a href='vertododdd'>        Ver Todos</a>")
	});
	socket.on('ObtenerUbicacion',DatosUbicacion);
	function DatosUbicacion(ubicacion){
		//console.log(ubicacion);
		iniciar(ubicacion);
	}
	function iniciar(ubicacion) {
		console.log(ubicacion.lat);
		console.log(ubicacion.lng);
		var mapOptions = {
			center: new google.maps.LatLng(ubicacion.lat, ubicacion.lng),
			zoom: 15,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map = new google.maps.Map(document.getElementById("map_canvas"),mapOptions);
		var pos = new google.maps.LatLng(ubicacion.lat, ubicacion.lng);
		marker = new google.maps.Marker({
            position: pos,
            map: map,
            title:"Ubicacion",
            animation: google.maps.Animation.DROP
        });
	} 
</script> 
{% endif %}
{% endblock %}
	